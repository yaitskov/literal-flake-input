# literal-flake-input

There are a web service and a command line tool **e**.  The service
translates an HTTP GET path into a Nix attrset that can be used as a
non-flake input. Such a workaround provides the ability to emulate
command line arguments in Nix flakes.

In addtition to the service there is a command line tool **e** that
helps with encoding, updating and inspecting input URLs in flake
files.

The tool supports literal keyword values (e.g. `true` and `null`),
strings, numbers, arrays and attribute sets.  String quotation is
optional. All values are parsed and evaluated by **e** with nix to
catch typos as soon as possible.


## `e` commands

### Init - add a new non-flake input to flake

``` shell
$ e i -name Bill -age 70
```

The flake file would look like that after:

``` nix
  # ...
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs";
    c = {
      url = https://lficom.me/name/%22Bill%22/age/70;
      flake = false;
    };
  };

```

### Pretty-printing URL as a Nix attrset

Checking a literal flake input URL in a flake file is not needed. A
value of literal flake input URL that is isomorphic to a Nix attrset can be
pretty-printed with `p` command:

``` shell
$ e p -age 20
```

``` nix
{ ... }:
  {
    age = 20;
    name = "Bill";
  }
```

### Merge

Merge updates values only for the specified attributes in a flake file.
Meanwhile init command overrides the whole URL.

``` shell
$ e m -name Bob && e p
```

``` nix
{ ... }:
  {
    age = 70;
    name = "Bob";
  }
```

### Remove an attribute

``` shell
$ e x age && e p
```

``` nix
{ ... }:
  {
    name = "Bob";
  }
```

### Overring input
The main **e** command generates an overriding flake input URL.
It gets an input URL stored in the flake file applies overrides from
command line arguments and prints the effective URL.

``` shell
$ nix build $(e -age 33)
```

The above command is an equivalent of:

``` shell
$ nix build --override-input c \
    https://lficom.me/name/%22Bob%22/age/33/.tar
```

## Flake template
The project flake is using
[itself](https://github.com/yaitskov/literal-flake-input/blob/4342efaa6d4a74143b235f40873bd72f13c02cd3/flake.nix#L8).
Another project using lfi is
[vpn-router](https://github.com/yaitskov/vpn-router).

``` nix
  # ...
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs";
    utils.url = "github:numtide/flake-utils";
    c = {
      url = https://lficom.me/name/Bill/;
      flake = false;
    };
  };
  outputs = { self, nixpkgs, utils, c }:
    utils.lib.eachDefaultSystem (sys:
      let
        pkgs = nixpkgs.legacyPackages.${sys};
        cnf = import c { inherit pkgs; };
      in
      {
        packages.hello =
          pkgs.writeShellScriptBin
            "hello"
            "echo Hello ${cnf.name}";
      });
  # ...
```

### All types demo


``` shell
e p -an1 true \
    -an2 null \
    -an3 12 \
    -an4 hello world \
    -an5 [ 1 2 ] \
    -an6 "{x = 1; y = 2; }" \
    -an7 x: x + 1\
    -an8 \(2+3\))
```

``` nix
{...}: {
  an1 = true;
  an2 = null;
  an3 = 12;
  an4 = "hello wolrd";
  an5 = [1 2];
  an6 = {x = 1; y = 2; };
  an7 = x: x + 1;
  an8 = (2+3);
}
```

### Notes

In case when an URL generated by default **e** subcommand is copied into a flake for default
values, then drop `.tar` suffix.

Alternative URL prefix can be set via environment variable `LFI_SITE`.

## Development environment

```shell
$ nix develop
$ emacs &
$ cabal build
$ cabal test
```

```shell
$ nix build
$ ./result/bin/literal-flake-input run
$ nix build $(./result/bin/e -static true)
```


## Installation

### Service
The service is already deployed at [lficom.me](https://lficom.me)

### NixOS module

#### NixOS with flakes

Modify `/etc/nixos/flake.nix` as follows:

``` nix
  # ...
  inputs = {
    # ...
    literal-flake-input.url = "github:yaitskov/literal-flake-input";
  };
```
``` nix
  # ...
        modules = [
          literal-flake-input.nixosModules.${system}.default
          ({ ... }: {
            programs.literal-flake-input = {
              enable = true;
              port = 3000;
            };
          })
          ./configuration.nix
        ];
```

#### NixOS without flakes
``` nix
  let
    lfi = builtins.fetchGit "htts://github.com/yaitskov/literal-flake-input.git?ref=master";
  in {
  imports =
    [ # ... ./hardware-configuration.nix
      "${lfi}/nixos/non-flake-lfi.nix"
    ];

```

``` nix
  programs = {
    literal-flake-input = {
      port = 3000;
      enable = true;
    };
  };
```
